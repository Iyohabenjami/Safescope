<!-- templates/report_modal.html -->
<div class="modal fade" id="reportModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content modal-dark">
      <div class="modal-header">
        <h5 class="modal-title text-white"><i class="bi bi-flag"></i> Submit Report</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body text-white">
        <form id="reportForm">
          <div class="mb-3">
            <label class="form-label small">Report Type</label>
            <select id="report_type" class="form-control dark-input">
              <option value="domain">Domain Issue</option>
              <option value="ip">IP Issue</option>
              <option value="security">Security Concern</option>
              <option value="false_positive">False Positive</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label small">Target</label>
            <input id="report_target" class="form-control dark-input" readonly />
          </div>

          <div class="mb-3">
            <label class="form-label small">Verdict</label>
            <select id="report_verdict" class="form-control dark-input">
              <option value="safe">Safe</option>
              <option value="suspicious">Suspicious</option>
              <option value="malicious">Malicious</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label small">Notes</label>
            <textarea id="report_note" class="form-control dark-input" rows="3"></textarea>
          </div>

          <div class="d-grid">
            <button class="btn main-btn" type="submit">Send Report</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
/* Report modal generic script â€“ works on all result pages.
   It fills target/verdict/type automatically from page globals or from .page-title element.
*/
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('reportForm');
  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    const payload = {
      type: document.getElementById('report_type').value,
      target: document.getElementById('report_target').value,
      verdict: document.getElementById('report_verdict').value,
      note: document.getElementById('report_note').value
    };
    try {
      const res = await fetch('/report', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      if (j.status === 'success') {
        alert('Report submitted');
        const modal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
        modal.hide();
      } else {
        alert('Failed: ' + (j.message || 'unknown'));
      }
    } catch (err) {
      alert('Network error');
    }
  });

  const modalEl = document.getElementById('reportModal');
  modalEl.addEventListener('show.bs.modal', function () {
    // Prefer explicit page-level variables, else try .page-title or .title text
    const target = window.SAFE_SCOPE_REPORT_TARGET || document.querySelector('.page-title')?.textContent?.trim() || '';
    const verdict = window.SAFE_SCOPE_REPORT_VERDICT || 'safe';
    document.getElementById('report_target').value = target;
    document.getElementById('report_verdict').value = verdict;

    const typeSel = document.getElementById('report_type');
    if (/\d+\.\d+\.\d+\.\d+/.test(target)) typeSel.value = 'ip';
    else typeSel.value = 'domain';
  });
});
</script>